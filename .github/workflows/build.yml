---
name: build pandoc-thesis

"on":
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - apko/pandoc-thesis.yaml

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  apko:
    name: build pandoc-thesis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
      actions: read
    outputs:
      digest: ${{ steps.apko.outputs.digest }}
    steps:
      - name: checkout project
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: apko snapshot
        id: apko
        uses: chainguard-images/actions/apko-snapshot@main
        with:
          config: apko/pandoc-thesis.yaml
          base-tag: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          target-tag: devel
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          token: ${{ secrets.GITHUB_TOKEN }}
          sbom-attest: true
          slsa-attest: true
  smoke:
    name: test pandoc-thesis
    needs: apko
    permissions:
      contents: read
    strategy:
      fail-fast: true
      matrix:
        os:
          - ubuntu-latest
        ce:
          - docker
          - podman
    runs-on: ${{ matrix.os }}
    steps:
      - name: checkout project
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: smoke test
        run: |
          set -x
          CE=${{ matrix.ce }} OCI=${{ needs.apko.outputs.digest }} make container
          CE=${{ matrix.ce }} make example
      - uses: actions/upload-artifact@694cdabd8bdb0f10b2cea11669e1bf5453eed0a6
        if: matrix.ce == 'docker'
        with:
          name: pandoc-thesis-example
          path: example.pdf
          if-no-files-found: error
          retention-days: 1
  publish:
    name: publish pandoc-thesis
    needs: smoke
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/download-artifact@6b208ae046db98c579e8a3aa621ab581ff575935
        with:
          name: pandoc-thesis-example
      - name: prepare html assets
        run: |
          set -x
          mkdir html/
          mv example.pdf html/
      - name: publish to gh-pages
        uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: html/
          keep_files: true
      - name: install crane
        uses: imjasonh/setup-crane@00c9e93efa4e1138c9a7a5c594acd6c75a2fbf0c
      # tag latest only after smoke tests
      - name: tag pandoc-thesis (latest)
        run: |
          crane tag "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:devel" latest
